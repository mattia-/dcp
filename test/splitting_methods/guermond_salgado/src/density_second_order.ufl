# first step of the Guermond-Salgado splitting method

# domain type
cell = triangle
h_K = Circumradius (cell)

# function spaces
V = VectorElement ("Lagrange", cell, 2)
R = FiniteElement ("Lagrange", cell, 2)

# coefficients
dt = Constant (cell)
u_old = Coefficient (V)
u_old_2 = Coefficient (V)
rho_old = Coefficient (R)
rho_old_2 = Coefficient (R)

# stabilization parameter
epsilon = 1e-6
delta = h_K / (sqrt(15) * sqrt (dot (u_old, u_old)) + epsilon)

# test and trial function
rho = TrialFunction (R)
r = TestFunction (R)

# density equation:
# lhs
a = 3.0 / (2.0 * dt) * inner (rho, r) * dx \
    + inner (dot (2 * u_old - u_old_2, grad (rho)), r) * dx \
    + delta * inner (dot (u_old, grad (rho)), dot (u_old, grad (r))) * dx

# rhs
L = 2.0 / dt * inner (rho_old, r) * dx - 1.0 / (2.0 * dt) * inner (rho_old_2, r) * dx
