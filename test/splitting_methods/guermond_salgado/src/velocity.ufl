# second step of the Guermond-Salgado splitting method

# domain type
cell = triangle

# function spaces
V = VectorElement ("Lagrange", cell, 2)
R = FiniteElement ("Lagrange", cell, 2)
Q = FiniteElement ("Lagrange", cell, 1)

# coefficients
dt = Constant (cell)
mu = Constant (cell)
u_old = Coefficient (V)
rho_old = Coefficient (R)
rho = Coefficient (R)
p_old = Coefficient (Q)
phi_old = Coefficient (Q)
# the external force is divided into two parts: f = f1 * rho + f2
# this is because rho is a solution, and there is no way to link it
# to a TimeDependentExpression
f1 = Coefficient (V)
f2 = Coefficient (V)

# test and trial function
u = TrialFunction (V)
v = TestFunction (V)

# velocity equation:
# lhs
a = 1 / dt * 0.5 * (rho + rho_old) * inner (u, v) * dx \
    + inner (rho * dot (u_old, grad (u)), v) * dx \
    + 0.5 * inner (div (rho * u_old) * u, v) * dx \
    + mu * inner (grad (u), grad (v)) * dx 
 
# rhs
L = 1 / dt * inner (rho_old * u_old, v) * dx \
    + inner (rho * f1, v) * dx \
    + inner (f2, v) * dx \
    - inner (grad (p_old + phi_old), v) * dx
