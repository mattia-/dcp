# second step of the Guermond-Salgado splitting method

# domain type
cell = triangle

# function spaces
V = VectorElement ("Lagrange", cell, 2)
R = FiniteElement ("Lagrange", cell, 2)
Q = FiniteElement ("Lagrange", cell, 1)

# coefficients
dt = Constant (cell)
mu = Constant (cell)
u_old = Coefficient (V)
u_old_2 = Coefficient (V)
u_star = Coefficient (V)
rho_old = Coefficient (R)
rho = Coefficient (R)
p_old = Coefficient (Q)
phi_old = Coefficient (Q)
phi_old_2 = Coefficient (Q)
# the external force is divided into two parts: f = f1 * rho + f2
# this is because rho is a solution, and there is no way to link it
# to a TimeDependentExpression
f1 = Coefficient (V)
f2 = Coefficient (V)

# test and trial function
u = TrialFunction (V)
v = TestFunction (V)

# coefficient value
u_star = 2 * u_old - u_old_2

# velocity equation:
# lhs
a = 3.0 / (2.0 * dt) * rho * inner (u, v) * dx \
    + inner (rho * dot (grad (u), u_star), v) * dx \
    + mu * inner (grad (u), grad (v)) * dx 
 
# rhs
L = 2.0 / dt * inner (rho * u_old, v) * dx \
    - 1.0 / (2.0 * dt) * inner (rho * u_old_2, v) * dx \
    + inner (rho * f1, v) * dx \
    + inner (f2, v) * dx \
    - inner (grad (p_old + 4.0 / 3.0 * phi_old - 1.0 / 3.0 * phi_old_2), v) * dx
